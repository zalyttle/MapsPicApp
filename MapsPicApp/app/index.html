<!DOCTYPE html>
<html>

<head>
  <link type="text/css" rel="stylesheet" href="styles.css">
  <!-- <script src="app.js"></script> -->
</head>

<body>
  <div class="container">
    <br>
    <div class="Row">
      <div class="Column">
        <img style='height: 50px; width: 50px;'src="00. Cover copy.jpg" alt="Mountain View">
      </div>
      <div class="Column">
        <div>Red Band Brigade</div>
        <div>Description:</div>
      </div>
      <div class="Column">
        <div>Login and Signup</div>
        <div>
          <input id="emailfield" type="text" name="Email" value="Email">
          <br>
          <input id="passwordfield" type="text" name="Password" value="Password">
          <br>
          <input id="signupbutton" type="submit" value="Sign Up">
          <input id="loginbutton" type="submit" value="Login">
        </div>
      </div>
    </div>
    <div>
      <input id="show-listings" type="button" value="Show Listings">
      <input id="hide-listings" type="button" value="Hide Listings">
    </div>
    <p>
      To post, just click the map and upload your photo and message. Click on pins to see others posts
    </p>
  </div>
  <div id="map"></div>


  

  <script src="https://www.gstatic.com/firebasejs/4.9.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.9.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.9.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.9.0/firebase.js"></script>
  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyCYtF1gZZ-MsO3U8kSetj5rNJY7Zhj1v-o",
      authDomain: "mapspicapp-61240.firebaseapp.com",
      databaseURL: "https://mapspicapp-61240.firebaseio.com",
      projectId: "mapspicapp-61240",
      storageBucket: "mapspicapp-61240.appspot.com",
      messagingSenderId: "1095635467477"
    };
    firebase.initializeApp(config);
  </script>

  <script>
    var map;

    // Create a new blank array for all the listing markers.
    var markers = [];
    var locations = [];
    var largeInfowindow;

    function Marker(name, location, latitude, longitude, message, imageURL) {
      this.name = name;
      this.location = location;
      this.latitude = latitude;
      this.longitude = longitude;
      this.message = message;
      this.imageURL = imageURL;
    }

    function initMap() {
      // Constructor creates a new map - only center and zoom are required.
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 40.7413549, lng: -73.9980244 },
        zoom: 13,
        mapTypeControl: false
      });

      largeInfowindow = new google.maps.InfoWindow();

      // Get a reference to the database service
      var database = firebase.database();

      // Get reference to 'markers' branch of database
      var markerRef = database.ref('markers');
      // Listener on markers branch
      markerRef.on('value', function (snapshot) {
        var i = 0;
        snapshot.forEach(function (childSnapshot) {
          // Read each child
          var name = childSnapshot.val().name;
          var location = childSnapshot.val().location;
          var latitude = childSnapshot.val().latitude;
          var longitude = childSnapshot.val().longitude;
          var message = childSnapshot.val().message;
          var imageURL = childSnapshot.val().imageURL;
          // Create new marker object
          var marker = new Marker(name, location, latitude, longitude, message, imageURL);
          console.log('Marker: ', marker);
          console.log('messageeeeeeee', message);

          // If this marker isn't already in the locations array, add it
          if (!locations.includes(marker)) {
            locations.push(marker);

            // Drop a pin
            var marker = new google.maps.Marker({
              position: { lat: latitude, lng: longitude },
              title: name,
              message: message,
              animation: google.maps.Animation.DROP,
              id: i
            });
            // Save the marker
            markers.push(marker);
            i++;

            // Create an onclick event to open an infowindow at each marker.
            marker.addListener('click', function () {
              populateInfoWindow(this, largeInfowindow);
            });
          }
        });
      });

      //function to add NEW marker on left click
      google.maps.event.addListener(map, 'click', function (event) {
        placeMarker(event.latLng);
      });

    }

    //ZL: This is where the html buttons are told what JS functions to run when 'clicked'
    document.getElementById('show-listings').addEventListener('click', showListings);
    document.getElementById('hide-listings').addEventListener('click', hideListings);
    document.getElementById('signupbutton').addEventListener('click', signupUser);
    document.getElementById('loginbutton').addEventListener('click', loginUser);
    



    // ---------- FUNCTIONS ---------- //
    function signupUser() {
      var emailinput = document.getElementById('emailfield');
      var email = emailinput.value;
      var passwordinput = document.getElementById('passwordfield');
      var password = passwordinput.value;
      console.log('SIGNUP: got email and password', email, password);

      firebase.auth().createUserWithEmailAndPassword(email, password).catch(function (error) {
        // Handle Errors here.
        var errorCode = error.code;
        var errorMessage = error.message;
        // ...
      });
      console.log('Signed up user! ');
    };

    function loginUser() {
      var emailinput = document.getElementById('emailfield');
      var email = emailinput.value;
      var passwordinput = document.getElementById('passwordfield');
      var password = passwordinput.value;
      console.log('LOGIN: got email and password', email, password);

      firebase.auth().signInWithEmailAndPassword(email, password).catch(function(error) {
        // Handle Errors here.
        var errorCode = error.code;
        var errorMessage = error.message;
        // ...
      });
    };

    function placeMarker(location) {
      var marker = new google.maps.Marker({
        position: location,
        animation: google.maps.Animation.DROP,
        map: map,
      });
      var initializedCount = 0;
      var newLargeInfowindow;

      console.log('placeMarker ran :) ');

      marker.addListener('click', function () {
        console.log('initializedCount within listener for new marker being clicked ', initializedCount);
        if (initializedCount == 0) {
          populateNewInfoWindow(this, largeInfowindow);
          console.log('ran populateNewInfoWindow() ');

          //ZL: Needs to be here so that Submit buttton works
          document.getElementById('infowindowSubmit').addEventListener('click', function (event) {
            // This function saves the newly created marker and the infowindow information when
            //the 'Submit' button is clicked.
            //ZL: Currently adds marker to 'locations' array. Will need to connect to database upon launch

            //Variables that store data inputted in infowindow
            var postName = document.getElementById('formName');
            var postNameF = postName.value;
            var postMessage = document.getElementById('formMessage');
            var postMessageF = postMessage.value;
            //postImage is set to message content for now for testing purposes. Please change later VVV
            var postImage = document.getElementById('fileInput');
            var postImageF = postImage.value;
            var latitude = location.lat(location);
            var longitude = location.lng(location);

            //Closes markers open infowindow
            largeInfowindow.close(map, marker);
            //Sets markers infowindow to NEW content
            largeInfowindow.setContent('<div>' + '<div>Name: ' + postNameF + '</div><br>' + '<div>Message: ' + postMessageF + '</div><br>' + '<div>Image: ' + postMessageF + '</div><br>' + '</div>');
            largeInfowindow.open(map, marker);
            // Make sure the marker property is cleared if the infowindow is closed.
            largeInfowindow.addListener('closeclick', function () {
              largeInfowindow.marker = null;
            });

            console.log('largeInfowindow after new content is set ', largeInfowindow);
            newLargeInfowindow = largeInfowindow;
            console.log('newLargeInfowindow after made equal to largeInfoWindow ', newLargeInfowindow);

            // Push the marker to our array of markers.
            console.log('actual marker ', marker, ' AND markers array before new marker is pushed ', markers);
            markers.push(marker);
            console.log('markers 2 ', markers);

            console.log('postNameF ', postNameF);
            console.log('location ', location);
            console.log('latitude ', latitude);
            console.log('longitude ', longitude);
            console.log('postMessageF ', postMessageF);
            console.log('PostImageF ', postImageF);
            //ZL: Code to write markers array to database
            writeUserData(postNameF, 'nun', latitude, longitude, postMessageF, postImageF);
            console.log('pushed new marker to database');

            initializedCount = 1;
          });

        } else if (initializedCount == 1) {
          console.log('NLIW after being clicked again ', newLargeInfowindow);
          populateFinalInfoWindow(this, newLargeInfowindow);
        } else {
          populateFinalInfoWindow(this, newLargeInfowindow);
        }

      });
    }

    // Writes data to firebase
    function writeUserData(name, location, latitude, longitude, message, imageURL) {
      firebase.database().ref('markers').push({
        name: name,
        location: location,
        latitude: latitude,
        longitude: longitude,
        message: message,
        imageURL: imageURL
      });
    }

    // This function populates the infowindow when the marker is clicked. We'll only allow
    // one infowindow which will open at the marker that is clicked, and populate based
    // on that markers position.
    function populateInfoWindow(marker, infowindow) {
      // Check to make sure the infowindow is not already opened on this marker.
      if (infowindow.marker != marker) {
        infowindow.marker = marker;
        infowindow.setContent('<div>' + '<div>Name: ' + marker.title + '</div><br>' + '<div>Message: ' + marker.message + '</div><br>' + '<div>Image: ' + marker.message + '</div><br>' + '</div>');
        infowindow.open(map, marker);
        // Make sure the marker property is cleared if the infowindow is closed.
        infowindow.addListener('closeclick', function () {
          infowindow.marker = null;
        });
      }
    }

    // This function populates the infowindow when the marker is clicked. We'll only allow
    // one infowindow which will open at the marker that is clicked, and populate based
    // on that markers position.
    function populateNewInfoWindow(marker, infowindow) {
      // Check to make sure the infowindow is not already opened on this marker.
      if (infowindow.marker != marker) {
        infowindow.marker = marker;
        infowindow.setContent('<div>' + '<form action="/action_page.php">Name: <input type="text" id="formName" name="Name" value="Name"><br>Message: <input type="text" id="formMessage" name="Message" value="Message"><br></form>' + '<input type="file" id="fileInput" name="fileInput" />' + '<br><input id="infowindowSubmit" type="submit" value="Submit">' + '</div>');
        infowindow.open(map, marker);
        // Make sure the marker property is cleared if the infowindow is closed.
        infowindow.addListener('closeclick', function () {
          infowindow.marker = null;
        });
      }
    }

    // This function populates the infowindow when the NEW marker is clicked after being saved. We'll only allow
    function populateFinalInfoWindow(marker, infowindow) {
      // Check to make sure the infowindow is not already opened on this marker.
      infowindow.open(map, marker);
      // Make sure the marker property is cleared if the infowindow is closed.
      infowindow.addListener('closeclick', function () {
        infowindow.marker = null;
      });
    }

    // This function will loop through the markers array and display them all.
    function showListings() {
      var bounds = new google.maps.LatLngBounds();
      // Extend the boundaries of the map for each marker and display the marker
      for (var i = 0; i < markers.length; i++) {
        //ZL: Makes markers appear on the map
        markers[i].setMap(map);
        bounds.extend(markers[i].position);
      }
      map.fitBounds(bounds);
    }

    // This function will loop through the listings and hide them all.
    function hideListings() {
      for (var i = 0; i < markers.length; i++) {
        markers[i].setMap(null);
      }
    }

  </script>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyComo2pvuhaip8QpzwmZKIZ2tUY6VejAfk&v=3&callback=initMap">
  </script>

</body>

</html>